<!DOCTYPE html>
<title>Summary</title>
<script src="https://unpkg.com/d3"></script>
<script src="https://unpkg.com/d3-array"></script>
<script src="https://unpkg.com/d3fc"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">

<style>
body {
  font-size: small;
  font-family: sans-serif;
}
div {
  display: block;
  margin: 20px;
}
d3fc-svg {
  display: block;
  height: 200px;
}
.domain, .gridline-y, .gridline-x, .annotation-line>line {
  stroke: currentColor;
  stroke-opacity: 0.1;
}
.line {
  stroke: inherit;
}
.legendCells {
  font-size: 0.8em;
}
</style>


<div id="raw" class="chart"></div>
<div id="hourly" class="chart"></div>
<div id="daily" class="chart"></div>
<div id="monthly" class="chart"></div>
<div id="table"></div>
<script>
d3.json('/summarydata').then(json_data => {
  //console.log(json_data);
  //parsed_data = json_data.map(x=>[new Date(x[0]/1e6),x[1],+x[2]]);
  parsed_data = json_data.map(x=>{
    return {
      time:x[0]/1e6,
      load:x[1],
      measure:+x[2]
    };
  });
  //console.log(parsed_data);

  //const grouped_data = d3.groups(data, d=>d[1])
  //const grouped_data = d3.groups(parsed_data, d=>d[1])
  const grouped_data = d3.groups(parsed_data, d=>d.load)
  grouped_data.sort((a,b)=>d3.ascending(a[0],b[0]));
console.log("grouped_data");
console.log(grouped_data);

  const group_vals = grouped_data.map(x => x[1]);

  //console.log(group_vals);

  daily = parsed_data.map(x=>{
    return {
      time:new Date(x.time).setHours(0,0,0,0),
      load:x.load,
      measure:x.measure
    };
  });
//console.log(daily);
  rolled = d3.rollups(daily, v=>d3.sum(v, d=>d.measure), d=>d.load, d=>d.time);
  console.log("rolled");
  console.log(rolled);

  const line = fc
    .seriesSvgLine()
    //.crossValue(d => new Date(d[0]/1e6))
    //.crossValue(d => d[0])
    .crossValue(d => new Date(d.time))
    //.mainValue(d => d[2]);
    .mainValue(d => d.measure);

  const color = d3.scaleOrdinal(d3.range(group_vals.length),
    d3.schemeCategory10);

  const series = fc.seriesSvgRepeat()
    .orient('horizontal')
    .series(line)
    .decorate(sel => { sel.attr('stroke', (_, i) => color(i)); });

  const flatdata = group_vals.flat();
  const chart = fc.chartCartesian(d3.scaleTime(), d3.scaleLinear())
    //.xDomain(fc.extentTime().accessors([d => new Date(d[0]/1e6)])(flatdata))
    //.xDomain(fc.extentTime().accessors([d => d[0]])(flatdata))
    .xDomain(fc.extentTime().accessors([d => new Date(d.time)])(flatdata))
    //.yDomain(fc.extentLinear().accessors([d => d[2]])(flatdata))
    .yDomain(fc.extentLinear().accessors([d => d.measure])(flatdata))
    .yLabel('kilowatt-hours')
    .yOrient('left')
    .svgPlotArea(series);

  const legend = d3.legendColor()
    .shapeWidth(30)
    .orient('vertical')
    .scale(color)
    .labels(grouped_data.map(x => x[0]));

  d3.select('div#hourly')
    .datum(group_vals)
    .call(chart.chartLabel('kWh by hour'))
    .select('d3fc-group d3fc-svg.plot-area svg')
    .call(legend);

  d3.select('div#daily')
    .datum(group_vals)
    .call(chart.chartLabel('kWh by day'))
    .select('d3fc-group d3fc-svg.plot-area svg')
    .call(legend);

  d3.select('div#monthly')
    .datum(group_vals)
    .call(chart.chartLabel('kWh by month'))
    .select('d3fc-group d3fc-svg.plot-area svg')
    .call(legend);

});


</script>
