<!DOCTYPE html>
<title>demo</title>

<script src="https://unpkg.com/babel-polyfill@6.26.0/dist/polyfill.js"></script>
<script src="https://unpkg.com/custom-event-polyfill@0.3.0/custom-event-polyfill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/document-register-element/1.8.0/document-register-element.js"></script>

<!-- Use babel so that we can use ES6 syntax -->
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<script src="https://unpkg.com/d3@5.14.2"></script>
<script src="https://unpkg.com/d3fc@14.1.0"></script>


<script type="module">
// SSE
var targetContainer = document.getElementById("target_div");
var eventSource = new EventSource("/stream")
eventSource.onmessage = function(e) {
  targetContainer.innerHTML = e.data;
};
</script>


<style>
  #chart {
    margin: auto;
    width: 900px;
    height: 450px;
  }

  .y-axis-label {
    white-space: nowrap;
  }
</style>

<h1>{{message}}</h1>

<div id="chart"></div>

<script type='text/babel'>
  const width = 820;
  const height = 384;

  const pointSeries = fc
    .seriesWebglPoint()
    .crossValue(d => d.carat)
    .mainValue(d => d.price)
    .size(4)
    .decorate(program => {
      fc.pointFill().color([1, 0, 0, 1])(program);
      fc.pointAntiAlias()(program);

      const gl = program.context();
      gl.enable(gl.BLEND);
      gl.blendFuncSeparate(
        gl.SRC_ALPHA,
        gl.ONE_MINUS_DST_ALPHA,
        gl.ONE,
        gl.ONE_MINUS_SRC_ALPHA
      );
    });

  const xExtent = fc
    .extentLinear()
    .accessors([d => d.carat])
    .pad([0.1, 0.1]);
  const yExtent = fc.extentLinear().accessors([d => d.price]);

  d3.tsv('/static/diamonds.tsv', type).then(data => {
    const xScale = d3.scaleLinear().domain(xExtent(data));
    const xScaleCopy = xScale.copy();
    const yScale = d3.scaleLinear().domain(yExtent(data));
    const yScaleCopy = yScale.copy();

    const zoom = d3
      .zoom()
      .extent([
        [0, 0],
        [width, height]
      ])
      .scaleExtent([1, 10])
      .translateExtent([
        [0, 0],
        [width, height]
      ])
      .on('zoom', () => {
        xScale.domain(d3.event.transform.rescaleX(xScaleCopy).domain());
        yScale.domain(d3.event.transform.rescaleY(yScaleCopy).domain());
        d3.select('d3fc-group')
          .node()
          .requestRedraw();
      });

    const decorate = selection => {
      selection
        .enter()
        .select('.plot-area')
        .on('measure.range', () => {
          xScaleCopy.range([0, d3.event.detail.width]);
          yScaleCopy.range([d3.event.detail.height, 0]);
        })
        .call(zoom);
    };

    const chart = fc
      .chartCartesian(xScale, yScale)
      .webglPlotArea(pointSeries)
      .xLabel('Mass (carats)')
      .yLabel('Price (US$)')
      .yTickFormat(d3.format('.3s'))
      .decorate(decorate);

    d3.select('#chart')
      .datum(data)
      .call(chart);
  });
  
  function type(d) {
    d.carat = Number(d.carat);
    d.price = Number(d.price);
    return d;
  }
</script>

<h1>{{message}}</h1>

<div id="target_div">Watch this space...</div>
<img src="/static/mosaic_logo.gif">


